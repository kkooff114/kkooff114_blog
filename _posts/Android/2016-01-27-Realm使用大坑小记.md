---
layout:         post
title:          Realm使用大坑小记
description:    由于Realm数据库还没有到1.0,处于高速迭代更新的阶段, 使用过程中碰到各种问题, 便记下
tags:           Android
keywords:       Android
noToc: 			  true
---

[TOC]

#Realm.refresh();
在一个线程中保存数据, `紧接着`在另一个线程中查询他, 
此时在查询的时候需要调用`realm.refresh();`来刷新数据
我的理解是一个线程中保存数据的时候数据库中存在缓存, realm感觉是以线程为单位做事的, 所以这个时候在另一个线程中查询的时候就会查不到数据

```
public static RealmResults<CrmReportZGSum> findAll(){
        Realm realm = Realm.getDefaultInstance();
        realm.refresh(); // <<===添加了才能查到
        RealmResults<CrmReportZGSum> zgSums = null;
        try {
            zgSums = realm.where(CrmReportZGSum.class).findAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
//            realm.close();
        }

        return zgSums;
    }
```

#Realm.close();
像上面的代码, 如果在finally中将realm Close掉, 返回的`RealmResults`对象将不可用, 会报数据库已经被关闭的错误. 
情景2. findAllAsync调用后close掉, 还能查到数据,代码参考业绩面板业代列表


#Mult-Dex为true带来的java.lang.ClassNotFoundException
```
Caused by: java.lang.ClassNotFoundException: 

io.realm.DefaultRealmModuleMediator                                                                                        

at java.lang.Class.classForName(Native Method)                                                        

at java.lang.Class.forName(Class.java:204)                                             

at java.lang.Class.forName(Class.java:169)
                                                                                           
```

原因:
当设置`multiDexEnabled true`的时候, android打包的时候有可能会将realm的数据库对象放到第二个dex中, 从而导致程序在加载的时候找不到相关Class

~~解决方案:~~
在Application中对所有的Realm进行引用

```
System.out.println(OrderSkuItemUploader.class);
```

参考
https://github.com/realm/realm-java/issues/1807
https://github.com/realm/realm-java/issues/1815

最优解决方案:
1.

```
dependencies {
  ...
  compile 'com.android.support:multidex:1.0.0'
} 
```
2.

```
public class MyApplication extends MultiDexApplication { .. }
```
3.Call MultiDex#install from your Application#attachBaseContext method:

```
public class MyApplication {
    protected void attachBaseContext(Context base) {
        super.attachBaseContext(base);
        MultiDex.install(this);
        ....
    }
    ....
}
```

参考
http://stackoverflow.com/questions/15209831/unable-to-execute-dex-method-id-not-in-0-0xffff-65536/26196397#26196397


